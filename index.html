<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Meal & Play</title>
    <meta name="description" content="L'asilo a portata di mano">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Menu Asilo Magic">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #ff7b00 0%, #e91e63 50%, #ff4081 100%);
            color: #2d3748;
            line-height: 1.6;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 0.5rem;
            padding: 1rem 0.5rem;
        }

        h1 {
            color: #ffffff;
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 0.3rem;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .week-info {
            color: #e9d5ff;
            font-size: 1.2rem;
            font-weight: 400;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #333333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: #ffffff;
            box-shadow: 0 8px 30px rgba(66, 153, 225, 0.4);
            transform: scale(1.05);
        }

        .section {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border-radius: 30px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section.hidden {
            display: none;
        }

        .selectors {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .selector-btn {
            padding: 0.8rem 1.8rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ff7b00 0%, #e91e63 100%);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .selector-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .selector-btn.active {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            box-shadow: 0 8px 30px rgba(66, 153, 225, 0.4);
            border: 3px solid #2b6cb0;
        }

        /* Activities section specific layout - 2x2 grid */
        #activities-section .selectors {
            max-width: 400px;
            margin: 0 auto 2rem;
        }

        #activities-section .selector-btn {
            flex: 0 0 calc(50% - 0.5rem);
            min-width: 0;
            height: auto;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: nowrap;
        }

        .quick-view-header {
            text-align: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b95 100%);
            border-radius: 15px;
            color: white;
            display: inline-block;
        }

        .quick-view-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .menu-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .day-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 25px;
            padding: 1.8rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .day-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff7b00, #e91e63, #ff4081);
            border-radius: 25px 25px 0 0;
        }

        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .day-card.today {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #ff7b00;
        }

        .day-card.today::before {
            background: linear-gradient(90deg, #ff7b00, #e91e63, #ffc107);
        }

        .day-card h2 {
            color: #2d3748;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .menu-list {
            margin-top: 0.5rem;
        }

        .menu-item {
            margin-bottom: 0.5rem;
            padding: 0.3rem 0;
            color: #2d3748;
            font-size: 0.95rem;
            line-height: 1.4;
            border-left: 3px solid;
            padding-left: 0.8rem;
        }

        .menu-item:nth-child(1) { border-left-color: #f56565; }
        .menu-item:nth-child(2) { border-left-color: #ed8936; }
        .menu-item:nth-child(3) { border-left-color: #ecc94b; }

        .activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .activity-day-card {
            background: linear-gradient(135deg, #ffffff 0%, #fff9f5 100%);
            border-radius: 25px;
            padding: 1rem;
            box-shadow: 0 15px 40px rgba(255, 154, 86, 0.15);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 154, 86, 0.1);
            border-left: 4px solid #ff9a56;
        }

        .activity-day-card.today {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe0cc 100%);
            border-color: #ff9a56;
        }

        .activity-day-card h3 {
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .activity-moment {
            margin-bottom: 0.5rem;
            padding: 0.4rem;
        }

        .activity-moment-title {
            color: #4a5568;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .activity-moment-content {
            color: #2d3748;
            font-size: 0.95rem;
        }

        .add-combination-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ff9a56 0%, #ff8fab 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 154, 86, 0.3);
            margin: 1rem auto;
            display: block;
        }

        .add-combination-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(72, 187, 120, 0.4);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
            font-style: italic;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem;
            color: #ffe0cc;
            font-size: 0.9rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 25px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #4a5568;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.cancel {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
            color: #4a5568;
        }

        .modal-btn.save {
            background: linear-gradient(135deg, #ff9a56 0%, #ff8fab 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(255, 154, 86, 0.3);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .combinations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .combination-card {
            background: linear-gradient(135deg, #ffffff 0%, #fff9f5 100%);
            border-radius: 25px;
            padding: 1.8rem;
            box-shadow: 0 15px 40px rgba(255, 154, 86, 0.15);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 154, 86, 0.1);
            position: relative;
            border-left: 4px solid #ff9a56;
        }

        .combination-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .combination-card h3 {
            color: #2d3748;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: left;
            padding-right: 60px;
        }

        .combination-card p {
            color: #4a5568;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .combination-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .combination-actions .modal-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .current-info {
            margin: 1rem 0;
            padding: 1rem;
        }

        .current-info h4 {
            color: #2d3748;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .menu-preview,
        .activity-preview {
            margin: 0.5rem 0;
        }

        .menu-preview strong,
        .activity-preview strong {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .menu-preview small,
        .activity-preview small {
            color: #2d3748;
            font-size: 0.8rem;
            line-height: 1.3;
            display: block;
            margin: 0.2rem 0;
        }

        .no-data {
            color: #718096;
            font-style: italic;
            font-size: 0.85rem;
            margin: 0.5rem 0;
        }

        .mini-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }

        .mini-toggle-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ff7b00 0%, #e91e63 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .mini-toggle-btn:active {
            background: linear-gradient(135deg, #e91e63 0%, #ff4081 100%);
            transform: scale(0.95);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }

        .combination-card.deleting {
            animation: deletePulse 1.5s ease-in-out;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%) !important;
            border-color: #f56565 !important;
        }

        @keyframes deletePulse {
            0% { transform: scale(1); }
            25% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            75% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .mini-toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .mini-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .mini-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #ff9a56 0%, #ff8fab 100%);
            transition: .4s;
            border-radius: 34px;
            box-shadow: 0 1px 4px rgba(255, 154, 86, 0.3);
        }

        .mini-toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .mini-toggle-slider {
            background: linear-gradient(135deg, #ff6b95 0%, #ff8fab 100%);
            box-shadow: 0 1px 4px rgba(255, 107, 149, 0.3);
        }

        input:checked + .mini-toggle-slider:before {
            transform: translateX(16px);
        }

        .delete-icon {
            position: absolute;
            top: 1.2rem;
            right: 1.2rem;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(238, 90, 82, 0.3);
        }

        .delete-icon:hover {
            background: linear-gradient(135deg, #ee5a52 0%, #dc4441 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(238, 90, 82, 0.4);
        }

        .mobile-day-tab {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ff9a56 0%, #ff8fab 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 154, 86, 0.3);
        }

        .mobile-day-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .mobile-day-tab.active {
            background: linear-gradient(135deg, #ff6b95 0%, #ff8fab 100%);
            box-shadow: 0 8px 30px rgba(255, 107, 149, 0.4);
        }

        .tomorrow-info {
            display: none;
        }

        .mobile-day-tab {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ff9a56 0%, #ff8fab 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 154, 86, 0.3);
        }


        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                gap: 0.5rem;
            }

            .nav-tab {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }

            .section {
                padding: 1.5rem;
            }

            .menu-container {
                grid-template-columns: 1fr;
            }

            .activities-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }

            .combinations-grid {
                grid-template-columns: 1fr;
            }

            .mobile-day-toggle {
                display: flex;
            }


            .combination-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Meal & Play</h1>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="favorites">Preferiti</button>
            <button class="nav-tab" data-tab="menu">Menu</button>
            <button class="nav-tab" data-tab="activities">Attivit√†</button>
        </nav>

        <section id="favorites-section" class="section">
            <div id="favorites-content">
                <div class="loading">Nessun preferito salvato. Clicca su "Aggiungi" per iniziare!</div>
            </div>
            
            <div id="create-favorite-container" style="text-align: center; margin-top: 2rem; display: none;">
                <button class="add-combination-btn" onclick="openCombinationModal()">
                    Aggiungi
                </button>
            </div>
        </section>

        <section id="menu-section" class="section hidden">
            <div class="selectors">
                <button class="selector-btn active" data-menu-type="nido">Piccoli</button>
                <button class="selector-btn" data-menu-type="infanzia">Grandi</button>
            </div>
            <div id="quick-view">
                <div class="loading">Caricamento menu in corso...</div>
            </div>
        </section>

        <section id="activities-section" class="section hidden">
            <div class="selectors">
                <button class="selector-btn active" data-activity-group="nido">Nido</button>
                <button class="selector-btn" data-activity-group="primavera">Primavera</button>
                <button class="selector-btn" data-activity-group="infanzia1">Infanzia 1</button>
                <button class="selector-btn" data-activity-group="infanzia2">Infanzia 2</button>
            </div>
            <div id="activities-content">
                <div class="loading">Caricamento attivit√† in corso...</div>
            </div>
        </section>

        <footer>
            <p>Made with love for little ones</p>
            <p id="config-date"></p>
        </footer>
    </div>

    <!-- Combination Modal -->
    <div id="combination-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Crea il tuo Preferito</h2>
            </div>
            <form id="combination-form">
                <div class="form-group">
                    <label for="combination-name">Nome</label>
                    <input type="text" id="combination-name" placeholder="Dai un nome alla tua combinazione..." required>
                </div>
                <div class="form-group">
                    <label for="combination-menu">Tipo Menu</label>
                    <select id="combination-menu" required>
                        <option value="nido">Piccoli</option>
                        <option value="infanzia">Grandi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="combination-activity">Gruppo Attivit√†</label>
                    <select id="combination-activity" required>
                        <option value="nido">Nido</option>
                        <option value="primavera">Primavera</option>
                        <option value="infanzia1">Infanzia 1</option>
                        <option value="infanzia2">Infanzia 2</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" onclick="closeCombinationModal()">Annulla</button>
                    <button type="submit" class="modal-btn save">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Conferma Eliminazione</h2>
            </div>
            <p style="text-align: center; margin-bottom: 2rem; color: #4a5568;">Sei sicuro di voler eliminare questo preferito?</p>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="closeDeleteModal()">Annulla</button>
                <button type="button" class="modal-btn save" onclick="confirmDelete()">Elimina</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'favorites';
        let currentMenuType = 'nido';
        let currentActivityGroup = 'nido';
        let MENU_NIDO = {};
        let MENU_INFANZIA = {};
        let ACTIVITIES = {};
        let WEEK_1_MONDAY = '';
        let combinations = [];
        let editingCombinationId = null;
        let deleteTargetId = null;

        // Utility functions
        function getCurrentDay(date) {
            const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            return days[date.getDay()];
        }

        function getWeekNumber(date) {
            const startDate = new Date(WEEK_1_MONDAY);
            const diffTime = date.getTime() - startDate.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weekNum = Math.floor(diffDays / 7) + 1;
            return Math.max(1, Math.min(4, weekNum));
        }

        // Load data functions
        async function loadWeekConfig() {
            try {
                const timestamp = Date.now();
                const response = await fetch(`week-config.txt?t=${timestamp}`);
                const text = await response.text();
                WEEK_1_MONDAY = text.trim();
                console.log('Week config loaded:', WEEK_1_MONDAY);
            } catch (error) {
                console.error('Error loading week config:', error);
                WEEK_1_MONDAY = '2025-09-30'; // Default
            }
        }

        function loadCombinations() {
            const saved = localStorage.getItem('combinations');
            if (saved) {
                combinations = JSON.parse(saved);
            }
            console.log('Loaded combinations:', combinations);
        }

        function saveCombinations() {
            localStorage.setItem('combinations', JSON.stringify(combinations));
            console.log('Saved combinations:', combinations);
        }

        function openCombinationModal(combinationId = null) {
            const modal = document.getElementById('combination-modal');
            const form = document.getElementById('combination-form');
            const modalTitle = document.getElementById('modal-title');
            
            if (combinationId) {
                // Edit mode
                editingCombinationId = combinationId;
                const combination = combinations.find(c => c.id === combinationId);
                
                if (combination) {
                    document.getElementById('combination-name').value = combination.name;
                    document.getElementById('combination-menu').value = combination.menuType;
                    document.getElementById('combination-activity').value = combination.activityGroup;
                }
                modalTitle.textContent = 'Modifica Preferito';
            } else {
                // Create mode
                editingCombinationId = null;
                form.reset();
                modalTitle.textContent = '';
            }
            
            modal.classList.add('active');
        }

        function closeCombinationModal() {
            const modal = document.getElementById('combination-modal');
            modal.classList.remove('active');
            editingCombinationId = null;
        }

        async function loadMenuData() {
            try {
                const timestamp = Date.now();
                const [nidoResponse, infanziaResponse] = await Promise.all([
                    fetch(`menu-nido.txt?t=${timestamp}`),
                    fetch(`menu-infanzia.txt?t=${timestamp}`)
                ]);
                
                const nidoText = await nidoResponse.text();
                const infanziaText = await infanziaResponse.text();
                
                MENU_NIDO = parseMenuData(nidoText);
                MENU_INFANZIA = parseMenuData(infanziaText);
                console.log('Menu data loaded:', { 
                    nido: Object.keys(MENU_NIDO).length, 
                    infanzia: Object.keys(MENU_INFANZIA).length 
                });
            } catch (error) {
                console.error('Error loading menu data:', error);
            }
        }

        function parseMenuData(text) {
            const menu = {};
            const lines = text.split('\n');
            
            const dayMap = {
                '1': 'Luned√¨',
                '2': 'Marted√¨', 
                '3': 'Mercoled√¨',
                '4': 'Gioved√¨',
                '5': 'Venerd√¨'
            };
            
            for (const line of lines) {
                if (line.trim() === '' || line.startsWith('#')) {
                    continue;
                }
                
                const parts = line.split('|').map(p => p.trim());
                if (parts.length >= 5) {
                    const weekNum = parseInt(parts[0]);
                    const dayNum = parts[1];
                    const primo = parts[2];
                    const secondo = parts[3];
                    const frutta = parts[4];
                    
                    if (weekNum >= 1 && weekNum <= 4 && dayMap[dayNum]) {
                        if (!menu[weekNum]) {
                            menu[weekNum] = {};
                        }
                        menu[weekNum][dayMap[dayNum]] = { primo, secondo, frutta };
                    }
                }
            }
            
            return menu;
        }

        async function loadActivitiesData() {
            try {
                const timestamp = Date.now();
                const response = await fetch(`activities.txt?t=${timestamp}`);
                const text = await response.text();
                ACTIVITIES = parseActivitiesData(text);
                console.log('Activities data loaded:', Object.keys(ACTIVITIES).length);
            } catch (error) {
                console.error('Error loading activities data:', error);
            }
        }

        function parseActivitiesData(text) {
            const activities = {};
            const lines = text.split('\n');
            
            // Day mapping (1=Luned√¨, 2=Marted√¨, etc.)
            const dayMap = {
                '1': 'Luned√¨',
                '2': 'Marted√¨', 
                '3': 'Mercoled√¨',
                '4': 'Gioved√¨',
                '5': 'Venerd√¨',
                '6': 'Sabato'
            };
            
            for (const line of lines) {
                if (line.trim() === '' || line.startsWith('#')) {
                    continue;
                }
                
                // Parse format: gruppo|giorno|attivita_mattino|attivita_pomeriggio
                const parts = line.split('|').map(p => p.trim());
                if (parts.length >= 4) {
                    const group = parts[0];
                    const dayNum = parts[1];
                    const mattino = parts[2];
                    const pomeriggio = parts[3];
                    
                    if (dayMap[dayNum]) {
                        if (!activities[group]) {
                            activities[group] = {};
                        }
                        
                        const dayName = dayMap[dayNum];
                        
                        // Store activities as separate morning and afternoon items
                        activities[group][dayName] = {
                            mattino: mattino !== '-' ? mattino : null,
                            pomeriggio: pomeriggio !== '-' ? pomeriggio : null
                        };
                    }
                }
            }
            
            return activities;
        }

        // Display functions
        function displayFavorites() {
            const favoritesContent = document.getElementById('favorites-content');
            const createContainer = document.getElementById('create-favorite-container');
            
            if (combinations.length === 0) {
                favoritesContent.innerHTML = `
                    <div class="loading">Nessun preferito salvato. Clicca su "Crea il tuo Preferito" per iniziare!</div>
                `;
                createContainer.style.display = 'block';
                return;
            }
            
            // Show create button at bottom if there are favorites
            createContainer.style.display = 'block';
            
            let html = '<div class="combinations-grid">';
            combinations.forEach(combination => {
                const currentData = getCurrentMenuAndActivities(combination.menuType, combination.activityGroup);
                
                html += `
                    <div class="combination-card">
                        <button class="delete-icon" onclick="openDeleteModal('${combination.id}')" title="Rimuovi preferito">√ó</button>
                        <h3>${combination.name}</h3>
                        
                        <div class="current-info today-info-${combination.id}">
                            <h4>Oggi - ${currentData.today.day} <button class="mini-toggle-btn" style="float: right;" onmousedown="showTomorrowTemporarily('${combination.id}')" onmouseup="hideTomorrowTemporarily('${combination.id}')" onmouseleave="hideTomorrowTemporarily('${combination.id}')" ontouchstart="showTomorrowTemporarily('${combination.id}')" ontouchend="hideTomorrowTemporarily('${combination.id}')" ontouchcancel="hideTomorrowTemporarily('${combination.id}')">Domani</button></h4>
                            ${currentData.today.menu ? `
                                <div class="menu-list">
                                    <p class="menu-item">${currentData.today.menu.primo}</p>
                                    <p class="menu-item">${currentData.today.menu.secondo}</p>
                                    <p class="menu-item">${currentData.today.menu.frutta}</p>
                                </div>
                            ` : '<p class="no-data">Nessun menu oggi</p>'}
                            ${currentData.today.activity ? `
                                <div class="activity-preview">
                                    <strong>Attivit√†:</strong><br>
                                    <small>${currentData.today.activity.replace(/<br>/g, ' ‚Ä¢ ')}</small>
                                </div>
                            ` : '<p class="no-data">Nessuna attivit√† oggi</p>'}
                        </div>
                        
                        <div class="current-info tomorrow-info-${combination.id}" style="display: none;">
                            <h4>Domani - ${currentData.tomorrow.day}</h4>
                            ${currentData.tomorrow.menu ? `
                                <div class="menu-list">
                                    <p class="menu-item">${currentData.tomorrow.menu.primo}</p>
                                    <p class="menu-item">${currentData.tomorrow.menu.secondo}</p>
                                    <p class="menu-item">${currentData.tomorrow.menu.frutta}</p>
                                </div>
                            ` : '<p class="no-data">Nessun menu domani</p>'}
                            ${currentData.tomorrow.activity ? `
                                <div class="activity-preview">
                                    <strong>Attivit√†:</strong><br>
                                    <small>${currentData.tomorrow.activity.replace(/<br>/g, ' ‚Ä¢ ')}</small>
                                </div>
                            ` : '<p class="no-data">Nessuna attivit√† domani</p>'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            favoritesContent.innerHTML = html;
        }

        let showTomorrowTimer = null;

        function showTomorrowTemporarily(combinationId) {
            clearTomorrowTimer();
            
            // For desktop, start a timer to show tomorrow after 500ms of holding
            showTomorrowTimer = setTimeout(() => {
                const todayInfo = document.querySelector(`.today-info-${combinationId}`);
                const tomorrowInfo = document.querySelector(`.tomorrow-info-${combinationId}`);
                
                if (todayInfo && tomorrowInfo) {
                    todayInfo.style.display = 'none';
                    tomorrowInfo.style.display = 'block';
                }
            }, 500);
        }

        function hideTomorrowTemporarily(combinationId) {
            clearTomorrowTimer();
            
            const todayInfo = document.querySelector(`.today-info-${combinationId}`);
            const tomorrowInfo = document.querySelector(`.tomorrow-info-${combinationId}`);
            
            if (todayInfo && tomorrowInfo) {
                todayInfo.style.display = 'block';
                tomorrowInfo.style.display = 'none';
            }
        }

        function clearTomorrowTimer() {
            if (showTomorrowTimer) {
                clearTimeout(showTomorrowTimer);
                showTomorrowTimer = null;
            }
        }


        function getActivityGroupName(group) {
            const names = {
                'nido': 'Nido',
                'primavera': 'Primavera',
                'infanzia1': 'Infanzia 1',
                'infanzia2': 'Infanzia 2'
            };
            return names[group] || group;
        }

        function openDeleteModal(combinationId) {
            deleteTargetId = combinationId;
            const modal = document.getElementById('delete-modal');
            modal.classList.add('active');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('active');
            deleteTargetId = null;
        }

        function confirmDelete() {
            if (deleteTargetId) {
                combinations = combinations.filter(c => c.id !== deleteTargetId);
                saveCombinations();
                displayFavorites();
                closeDeleteModal();
            }
        }

        function deleteCombination(combinationId) {
            // This function is kept for compatibility but no longer used
            combinations = combinations.filter(c => c.id !== combinationId);
            saveCombinations();
            displayFavorites();
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getCurrentMenuAndActivities(menuType, activityGroup) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const currentWeek = getWeekNumber(today);
            const tomorrowWeek = getWeekNumber(tomorrow);
            
            const todayDay = getCurrentDay(today);
            const tomorrowDay = getCurrentDay(tomorrow);
            
            // Get menu data
            const menuData = menuType === 'nido' ? MENU_NIDO : MENU_INFANZIA;
            let todayMenu = null;
            let tomorrowMenu = null;
            
            if (menuData[currentWeek] && menuData[currentWeek][todayDay]) {
                todayMenu = menuData[currentWeek][todayDay];
            }
            
            if (menuData[tomorrowWeek] && menuData[tomorrowWeek][tomorrowDay]) {
                tomorrowMenu = menuData[tomorrowWeek][tomorrowDay];
            }
            
            // Get activities data
            const activitiesData = ACTIVITIES[activityGroup];
            let todayActivity = null;
            let tomorrowActivity = null;
            
            if (activitiesData && activitiesData[todayDay]) {
                const activities = activitiesData[todayDay];
                let content = '';
                
                if (activities.mattino && activities.pomeriggio) {
                    content = `Mattino: ${activities.mattino}<br>Pomeriggio: ${activities.pomeriggio}`;
                } else if (activities.mattino) {
                    content = `Mattino: ${activities.mattino}`;
                } else if (activities.pomeriggio) {
                    content = `Pomeriggio: ${activities.pomeriggio}`;
                } else {
                    content = 'Nessuna attivit√† programmata';
                }
                
                todayActivity = content;
            }
            
            if (activitiesData && activitiesData[tomorrowDay]) {
                const activities = activitiesData[tomorrowDay];
                let content = '';
                
                if (activities.mattino && activities.pomeriggio) {
                    content = `Mattino: ${activities.mattino}<br>Pomeriggio: ${activities.pomeriggio}`;
                } else if (activities.mattino) {
                    content = `Mattino: ${activities.mattino}`;
                } else if (activities.pomeriggio) {
                    content = `Pomeriggio: ${activities.pomeriggio}`;
                } else {
                    content = 'Nessuna attivit√† programmata';
                }
                
                tomorrowActivity = content;
            }
            
            return {
                today: { menu: todayMenu, activity: todayActivity, day: todayDay },
                tomorrow: { menu: tomorrowMenu, activity: tomorrowActivity, day: tomorrowDay }
            };
        }

        // Display functions
        function displayQuickView() {
            const quickView = document.getElementById('quick-view');
            const today = new Date();
            const currentWeek = getWeekNumber(today);
            const currentDay = getCurrentDay(today);
            
            console.log('Displaying quick view:', { currentWeek, currentDay, currentMenuType });
            
            quickView.innerHTML = '';
            
            const quickViewHeader = document.createElement('div');
            quickViewHeader.className = 'quick-view-header';
            quickViewHeader.innerHTML = `<h2>Settimana ${currentWeek}</h2>`;
            quickView.appendChild(quickViewHeader);
            
            const menuContainer = document.createElement('div');
            menuContainer.className = 'menu-container';
            
            const dayOrder = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨'];
            const menuData = currentMenuType === 'nido' ? MENU_NIDO : MENU_INFANZIA;
            
            for (const day of dayOrder) {
                if (menuData[currentWeek] && menuData[currentWeek][day]) {
                    const dayCard = createDayCard(day, menuData[currentWeek][day], currentDay);
                    menuContainer.appendChild(dayCard);
                }
            }
            
            quickView.appendChild(menuContainer);
        }

        function createDayCard(day, menu, currentDay) {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            
            if (day === currentDay) {
                dayCard.classList.add('today');
            }
            
            dayCard.innerHTML = `
                <h2>${day}</h2>
                <div class="menu-list">
                    <p class="menu-item">${menu.primo}</p>
                    <p class="menu-item">${menu.secondo}</p>
                    <p class="menu-item">${menu.frutta}</p>
                </div>
            `;
            
            return dayCard;
        }

        function displayActivities() {
            const activitiesContent = document.getElementById('activities-content');
            const today = new Date();
            const currentDay = getCurrentDay(today);
            
            console.log('Displaying activities:', { currentDay, currentActivityGroup });
            
            activitiesContent.innerHTML = '';
            
            const activitiesGrid = document.createElement('div');
            activitiesGrid.className = 'activities-grid';
            
            const dayOrder = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const activitiesData = ACTIVITIES[currentActivityGroup];
            
            for (const day of dayOrder) {
                if (activitiesData && activitiesData[day]) {
                    const dayCard = createActivityDayCard(day, activitiesData[day], currentDay);
                    activitiesGrid.appendChild(dayCard);
                }
            }
            
            activitiesContent.appendChild(activitiesGrid);
        }

        function createActivityDayCard(day, activities, currentDay) {
            const dayCard = document.createElement('div');
            dayCard.className = 'activity-day-card';
            
            if (day === currentDay) {
                dayCard.classList.add('today');
            }
            
            let html = `<h3>${day}</h3>`;
            
            // Add Mattino section if there's a morning activity
            if (activities.mattino) {
                html += `
                    <div class="activity-moment">
                        <div class="activity-moment-title">üåÖ Mattino</div>
                        <div class="activity-moment-content">${activities.mattino}</div>
                    </div>
                `;
            }
            
            // Add Pomeriggio section if there's an afternoon activity
            if (activities.pomeriggio) {
                html += `
                    <div class="activity-moment">
                        <div class="activity-moment-title">üåá Pomeriggio</div>
                        <div class="activity-moment-content">${activities.pomeriggio}</div>
                    </div>
                `;
            }
            
            // If no activities at all
            if (!activities.mattino && !activities.pomeriggio) {
                html += `
                    <div class="activity-moment">
                        <div class="activity-moment-content">Nessuna attivit√† programmata</div>
                    </div>
                `;
            }
            
            dayCard.innerHTML = html;
            
            return dayCard;
        }

        // Tab switching
        async function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const clickedTab = document.querySelector(`[data-tab="${tab}"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Hide all sections
            document.getElementById('favorites-section').classList.add('hidden');
            document.getElementById('menu-section').classList.add('hidden');
            document.getElementById('activities-section').classList.add('hidden');
            
            // Show selected section
            if (tab === 'favorites') {
                document.getElementById('favorites-section').classList.remove('hidden');
                // Ensure data is loaded before displaying favorites
                if (Object.keys(MENU_NIDO).length === 0 || Object.keys(MENU_INFANZIA).length === 0 || Object.keys(ACTIVITIES).length === 0) {
                    await loadMenuData();
                    await loadActivitiesData();
                }
                displayFavorites();
            } else if (tab === 'menu') {
                document.getElementById('menu-section').classList.remove('hidden');
                if (Object.keys(MENU_NIDO).length === 0 || Object.keys(MENU_INFANZIA).length === 0) {
                    await loadMenuData();
                }
                displayQuickView();
            } else if (tab === 'activities') {
                document.getElementById('activities-section').classList.remove('hidden');
                if (Object.keys(ACTIVITIES).length === 0) {
                    await loadActivitiesData();
                }
                displayActivities();
            }
        }

        // Menu type selection
        function selectMenuType(type) {
            currentMenuType = type;
            
            // Update selector buttons
            document.querySelectorAll('#menu-section .selector-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const clickedBtn = document.querySelector(`#menu-section [data-menu-type="${type}"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            displayQuickView();
        }

        // Activity group selection
        function selectActivityGroup(group) {
            currentActivityGroup = group;
            
            // Update selector buttons
            document.querySelectorAll('#activities-section .selector-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const clickedBtn = document.querySelector(`#activities-section [data-activity-group="${group}"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            displayActivities();
        }

        // Initialize app
        async function initApp() {
            console.log('Initializing app...');
            await loadWeekConfig();
            await loadMenuData();
            await loadActivitiesData();
            loadCombinations();
            
            // Display favorites on initial load since favorites tab is active by default
            displayFavorites();
            
            console.log('App initialized successfully');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', async function() {
                    const tabName = this.getAttribute('data-tab');
                    await switchTab(tabName);
                });
            });
            
            // Menu type selector
            document.querySelectorAll('#menu-section .selector-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const menuType = this.getAttribute('data-menu-type');
                    selectMenuType(menuType);
                });
            });
            
            // Activity group selector
            document.querySelectorAll('#activities-section .selector-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const activityGroup = this.getAttribute('data-activity-group');
                    selectActivityGroup(activityGroup);
                });
            });
            
            // Combination form submit
            document.getElementById('combination-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('combination-name').value;
                const menuType = document.getElementById('combination-menu').value;
                const activityGroup = document.getElementById('combination-activity').value;
                
                if (editingCombinationId) {
                    // Update existing combination
                    const index = combinations.findIndex(c => c.id === editingCombinationId);
                    if (index !== -1) {
                        combinations[index] = { ...combinations[index], name, menuType, activityGroup };
                    }
                } else {
                    // Create new combination
                    const newCombination = {
                        id: generateId(),
                        name,
                        menuType,
                        activityGroup,
                        createdAt: new Date().toISOString()
                    };
                    combinations.push(newCombination);
                }
                
                saveCombinations();
                displayFavorites();
                closeCombinationModal();
            });
            
            // Start app
            initApp();
        });
    </script>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
